<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Retirada de Energéticos</title>
    <!-- Carrega o Tailwind CSS para estilização -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilo para o loader */
        .loader {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans p-4 md:p-8">

    <div class="max-w-5xl mx-auto bg-white shadow-lg rounded-lg p-6 md:p-8">

        <!-- Título -->
        <h1 class="text-3xl font-bold text-center text-blue-700 mb-8">
            Controle de Retirada de Energéticos
        </h1>

        <!-- Seção de Estoque Atual -->
        <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-800 p-6 rounded-lg mb-8 shadow-md">
            <h2 class="text-2xl font-semibold mb-2">Estoque Atual</h2>
            <div id="stock-container" class="flex items-center">
                <p id="stock-display" class="text-5xl font-bold">--</p>
                <!-- Loader de carregamento -->
                <div id="loading-stock" class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-8 w-8 ml-4"></div>
            </div>
        </div>

        <!-- Divisão de Layout (Formulário e Histórico) -->
        <div class="grid grid-cols-1 md:grid-cols-2 md:gap-8">

            <!-- Coluna do Formulário -->
            <div class="mb-8 md:mb-0">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2 text-gray-800">Registrar Nova Retirada</h2>
                <form id="withdrawal-form" class="space-y-4">
                    
                    <!-- Campo Nome -->
                    <div>
                        <label for="nome" class="block text-sm font-medium text-gray-700 mb-1">Nome de quem está retirando:</label>
                        <input type="text" id="nome" name="nome" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <!-- Campo Motivo -->
                    <div>
                        <label for="motivo" class="block text-sm font-medium text-gray-700 mb-1">Motivo da retirada:</label>
                        <input type="text" id="motivo" name="motivo" required placeholder="Ex: Evento de Marketing, Consumo..."
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <!-- Campo Quantidade -->
                    <div>
                        <label for="quantidade" class="block text-sm font-medium text-gray-700 mb-1">Quantidade:</label>
                        <input type="number" id="quantidade" name="quantidade" min="1" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <!-- Botão de Envio -->
                    <button type="submit" id="submit-button" 
                            class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-md shadow-lg
                                   hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2
                                   transition duration-150 ease-in-out disabled:bg-gray-400">
                        Registrar Retirada
                    </button>
                    
                    <!-- Mensagem de Erro/Sucesso -->
                    <div id="form-message" class="text-sm mt-3 text-center"></div>
                </form>
            </div>

            <!-- Coluna do Histórico -->
            <div>
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2 text-gray-800">Histórico de Retiradas</h2>
                <!-- Container com scroll para o histórico -->
                <div class="shadow rounded-lg overflow-x-auto border border-gray-200" style="max-height: 400px; overflow-y: auto;">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data/Hora</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Qtd.</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Motivo</th>
                            </tr>
                        </thead>
                        <tbody id="logs-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Linhas do histórico serão inseridas aqui -->
                            <tr>
                                <td colspan="4" class="p-4 text-center text-gray-500" id="loading-logs">
                                    Carregando histórico...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>


        <!-- ID de Autenticação -->
        <div class="mt-8 text-center text-xs text-gray-500">
            Sessão compartilhada. Conectado como:
            <code id="user-id-display" class="font-mono bg-gray-200 p-1 rounded">...</code>
        </div>
    </div>

    <!-- Scripts do Firebase -->
    <script type="module">
        // Importa as funções necessárias do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            collection, 
            addDoc, 
            onSnapshot, 
            runTransaction,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- VARIÁVEIS GLOBAIS DE CONFIGURAÇÃO ---
        // Estas variáveis são injetadas pelo ambiente. NÃO MUDE.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // Tenta pegar a configuração do Firebase injetada pelo ambiente
        const firebaseConfigJSON = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
        
        let firebaseConfig;
        try {
             firebaseConfig = JSON.parse(firebaseConfigJSON);
        } catch(e) {
            console.error("Configuração do Firebase inválida:", firebaseConfigJSON);
            firebaseConfig = {};
        }

        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- INICIALIZAÇÃO DO FIREBASE ---
        let app, auth, db;
        let userId; // ID do usuário autenticado
        let stockRef; // Referência para o documento do estoque
        let logsCollectionRef; // Referência para a coleção de históricos
        let currentStock = 0; // Armazena o valor atual do estoque

        // Elementos do DOM
        const stockDisplay = document.getElementById('stock-display');
        const loadingStock = document.getElementById('loading-stock');
        const logsTableBody = document.getElementById('logs-table-body');
        const loadingLogs = document.getElementById('loading-logs');
        const form = document.getElementById('withdrawal-form');
        const formMessage = document.getElementById('form-message');
        const submitButton = document.getElementById('submit-button');
        const userIdDisplay = document.getElementById('user-id-display');

        async function initializeFirebase() {
            // Verifica se a configuração do Firebase está presente
            // Se não tiver um projectId, significa que o Firebase não foi conectado
            if (!firebaseConfig.projectId) {
                console.error("Erro: Configuração do Firebase não encontrada. Conecte um projeto Firebase.");
                if(formMessage) {
                    formMessage.textContent = "Erro ao conectar com o banco de dados. Conecte um projeto Firebase em 'Serviços Conectados' ou 'Ambiente'.";
                    formMessage.className = "text-red-600 text-sm mt-3 text-center";
                }
                if(stockDisplay) stockDisplay.textContent = "Erro";
                if(loadingStock) loadingStock.style.display = "none";
                if(submitButton) submitButton.disabled = true;
                return; // Para a execução
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug'); // Habilita logs detalhados do Firestore

                // Autentica o usuário
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        if (userIdDisplay) userIdDisplay.textContent = userId;
                        console.log("Usuário autenticado:", userId);

                        // Define as referências do Firestore DEPOIS de ter o userId
                        setupFirestoreReferences();
                        
                        // Configura os listeners para atualizar a UI em tempo real
                        await setupStockListener();
                        setupLogsListener();
                        
                        // Habilita o formulário
                        if(form && submitButton) {
                            form.addEventListener('submit', handleFormSubmit);
                            submitButton.disabled = false;
                            submitButton.textContent = "Registrar Retirada";
                        } else {
                            console.error("Erro: Elementos do formulário (form ou submitButton) não encontrados no DOM.");
                        }

                    } else {
                        console.log("Usuário não autenticado, tentando login...");
                        
                        if(submitButton) {
                            submitButton.disabled = true;
                            submitButton.textContent = "Autenticando...";
                        }
                        // Tenta autenticar com o token inicial ou anonimamente
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });

            } catch (error) {
                console.error("Erro ao inicializar o Firebase:", error);
                if (stockDisplay) stockDisplay.textContent = "ERRO";
                
                if(formMessage) {
                    formMessage.textContent = "Erro ao inicializar o Firebase. Verifique a configuração.";
                    formMessage.className = "text-red-600";
                }
            }
        }

        // Define os caminhos do banco de dados
        function setupFirestoreReferences() {
            const initialStockValue = 1342; // Valor inicial definido por você
            
            // --- MUDANÇA PARA DADOS PÚBLICOS/COMPARTILHADOS ---
            // Usamos um caminho público em vez de um caminho de usuário
            // para que todos acessem os mesmos dados.
            
            // Caminho para o documento que armazena o estoque (agora compartilhado)
            stockRef = doc(db, "artifacts", appId, "public", "data", "energy_stock_shared", "main");
            
            // Caminho para a coleção que armazena os logs (agora compartilhado)
            logsCollectionRef = collection(db, "artifacts", appId, "public", "data", "energy_logs_shared");
        }

        // Configura o listener para o estoque
        async function setupStockListener() {
            const initialStockValue = 1342;
            
            if (loadingStock) {
                loadingStock.style.display = 'block';
            }

            try {
                // Verifica se o documento de estoque já existe
                const docSnap = await getDoc(stockRef);

                if (!docSnap.exists()) {
                    // Se não existir (primeira vez executando), cria com o valor inicial
                    console.log("Documento de estoque não encontrado. Criando com valor inicial:", initialStockValue);
                    await setDoc(stockRef, { current: initialStockValue });
                }

                // Configura o listener em tempo real (onSnapshot)
                onSnapshot(stockRef, (doc) => {
                    if (doc.exists()) {
                        currentStock = doc.data().current;
                        if (stockDisplay) stockDisplay.textContent = currentStock;
                        console.log("Estoque atualizado:", currentStock);
                    } else {
                        // Isso pode acontecer se o documento for deletado
                        console.log("Documento de estoque não existe, recriando...");
                        setDoc(stockRef, { current: initialStockValue });
                        currentStock = initialStockValue;
                        if (stockDisplay) stockDisplay.textContent = currentStock;
                    }
                    if (loadingStock) loadingStock.style.display = 'none';
                }, (error) => {
                    console.error("Erro ao ouvir estoque:", error);
                    if (stockDisplay) stockDisplay.textContent = "Erro";
                    if (loadingStock) loadingStock.style.display = 'none';
                });

            } catch (error) {
                console.error("Erro em setupStockListener:", error);
                if (stockDisplay) stockDisplay.textContent = "Erro";
                if (loadingStock) loadingStock.style.display = 'none';
            }
        }

        // Configura o listener para o histórico de retiradas
        function setupLogsListener() {
            onSnapshot(logsCollectionRef, (querySnapshot) => {
                const logs = [];
                querySnapshot.forEach((doc) => {
                    logs.push(doc.data());
                });

                // Ordena os logs em memória (mais recente primeiro)
                logs.sort((a, b) => {
                    // Adiciona verificação se timestamp existe antes de chamar toDate()
                    const timeA = a.timestamp ? a.timestamp.toDate() : 0;
                    const timeB = b.timestamp ? b.timestamp.toDate() : 0;
                    return timeB - timeA;
                });


                renderLogs(logs);

            }, (error) => {
                console.error("Erro ao ouvir histórico:", error);
                if (logsTableBody) {
                    logsTableBody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-500">Erro ao carregar histórico.</td></tr>`;
                }
            });
        }

        // Renderiza o histórico na tabela
        function renderLogs(logs) {
            if (!logsTableBody) return;
            
            logsTableBody.innerHTML = ''; // Limpa a tabela

            if (logs.length === 0) {
                logsTableBody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-gray-500">Nenhum registro de retirada ainda.</td></tr>`;
                return;
            }

            logs.forEach(log => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50";
                
                // Formata a data
                const timestamp = log.timestamp ? log.timestamp.toDate() : new Date(); // Fallback
                const formattedDate = timestamp.toLocaleString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                tr.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${formattedDate}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 font-medium">${escapeHTML(log.name)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 font-bold">${log.quantity}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${escapeHTML(log.reason)}</td>
                `;
                logsTableBody.appendChild(tr);
            });
        }

        // Função para lidar com o envio do formulário
        async function handleFormSubmit(event) {
            event.preventDefault();
            
            if (!submitButton || !form) return;

            submitButton.disabled = true;
            submitButton.textContent = "Registrando...";
            showFormMessage("", false); // Limpa mensagem

            // Pega os dados do formulário
            const nome = form.nome.value.trim();
            const motivo = form.motivo.value.trim();
            const quantidade = parseInt(form.quantidade.value, 10);
            const timestamp = new Date(); // Pega a data e hora atuais

            // --- Validação ---
            if (!nome || !motivo || !quantidade) {
                showFormMessage("Por favor, preencha todos os campos.", true);
                submitButton.disabled = false; // Reabilita o botão
                submitButton.textContent = "Registrar Retirada";
                return;
            }
            if (isNaN(quantidade) || quantidade <= 0) {
                showFormMessage("A quantidade deve ser um número positivo.", true);
                submitButton.disabled = false; // Reabilita o botão
                submitButton.textContent = "Registrar Retirada";
                return;
            }

            // --- Transação Firestore ---
            try {
                await runTransaction(db, async (transaction) => {
                    // 1. Pega o valor atual do estoque DENTRO da transação
                    const stockDoc = await transaction.get(stockRef);
                    if (!stockDoc.exists()) {
                        throw new Error("Documento de estoque não encontrado!");
                    }
                    
                    const stockAtualNoDB = stockDoc.data().current;

                    // 2. Valida se há estoque suficiente
                    if (quantidade > stockAtualNoDB) {
                        throw new Error(`Estoque insuficiente! Restam apenas ${stockAtualNoDB} unidades.`);
                    }

                    // 3. Calcula o novo estoque
                    const novoEstoque = stockAtualNoDB - quantidade;

                    // 4. Atualiza o estoque no banco de dados
                    transaction.update(stockRef, { current: novoEstoque });

                    // 5. Cria o novo registro de log
                    const newLogRef = doc(logsCollectionRef); // Cria uma referência para um novo doc
                    transaction.set(newLogRef, {
                        name: nome,
                        reason: motivo,
                        quantity: quantidade,
                        timestamp: timestamp // Salva o timestamp
                    });
                });

                // Sucesso!
                showFormMessage("Retirada registrada com sucesso!", false);
                form.reset(); // Limpa o formulário

            } catch (error) {
                console.error("Erro na transação:", error);
                // Exibe a mensagem de erro específica (ex: estoque insuficiente)
                showFormMessage(`Erro: ${error.message}`, true);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = "Registrar Retirada";
            }
        }

        // Mostra mensagens de feedback no formulário
        function showFormMessage(message, isError = false) {
            if (!formMessage) return;
            formMessage.textContent = message;
            formMessage.className = isError ? 'text-red-600 text-sm mt-3 text-center' : 'text-green-600 text-sm mt-3 text-center';
        }

        // Função simples para evitar XSS (Cross-Site Scripting)
        function escapeHTML(str) {
            if (typeof str !== 'string') str = String(str);
            return str.replace(/[&<>"']/g, function(m) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                }[m];
            });
        }

        // Inicia a aplicação
        initializeFirebase();

    </script>
</body>
</html>





